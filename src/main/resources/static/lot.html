<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Аукцион.ру — Лот</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<div class="container mt-5">
    <h1 id="title"></h1>
    <p id="description"></p>
    <div id="images" class="mb-3"></div>
    <h3>Текущая цена: <span id="currentPrice"></span>₽</h3>
    <div id="timer" class="mb-3"></div>
    <form id="bidForm" style="display: none;">
        <div class="input-group mb-3" style="max-width: 300px;">
            <input type="number" id="bidAmount" class="form-control" placeholder="Ваша ставка" min="0" step="0.01">
            <button type="submit" class="btn btn-primary">Сделать ставку</button>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const lotId = new URLSearchParams(window.location.search).get('id');
        if (!lotId) {
            alert('ID лота не указан');
            return;
        }

        const userId = localStorage.getItem('userId');

        try {
            const response = await fetch(`http://localhost:8080/lots/${lotId}`, {
                headers: userId ? { 'X-User-Id': userId } : {}
            });
            if (!response.ok) throw new Error('Лот не найден');
            const lot = await response.json();

            document.getElementById('title').textContent = lot.title;
            document.getElementById('description').textContent = lot.description || 'Описание отсутствует';
            document.getElementById('currentPrice').textContent = lot.currentPrice.toFixed(2);

            const imagesDiv = document.getElementById('images');
            if (lot.images && lot.images.length > 0) {
                lot.images.forEach(image => {
                    const img = document.createElement('img');
                    img.src = image.url;
                    img.alt = lot.title;
                    img.className = 'img-thumbnail me-2';
                    img.style.maxWidth = '150px';
                    imagesDiv.appendChild(img);
                });
            } else {
                imagesDiv.innerHTML = '<p class="text-muted">Изображения отсутствуют</p>';
            }

            const endTime = new Date(lot.endTime).getTime();
            startCountdown(endTime);

            if (userId) {
                document.getElementById('bidForm').style.display = 'block';
                setupBidForm(lotId, userId);
            } else {
                document.getElementById('bidForm').outerHTML = '<p class="text-muted">Войдите, чтобы сделать ставку</p>';
            }

            const socket = new SockJS('/ws');
            const stompClient = Stomp.over(socket);
            stompClient.connect({}, () => {
                stompClient.subscribe(`/topic/lots/${lotId}`, (message) => {
                    const newPrice = parseFloat(message.body);
                    document.getElementById('currentPrice').textContent = newPrice.toFixed(2);
                });
            });
        } catch (error) {
            console.error('Ошибка:', error);
            alert('Не удалось загрузить лот');
        }
    });

    function setupBidForm(lotId, userId) {
        document.getElementById('bidForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const bidAmount = parseFloat(document.getElementById('bidAmount').value);
            if (!bidAmount || bidAmount <= 0) {
                alert('Введите корректную сумму ставки');
                return;
            }

            try {
                const response = await fetch('http://localhost:8080/bids', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Id': userId
                    },
                    body: JSON.stringify({ lotId, amount: bidAmount })
                });

                if (!response.ok) throw new Error('Ошибка при размещении ставки');
                document.getElementById('bidAmount').value = '';
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Не удалось сделать ставку');
            }
        });
    }

    function startCountdown(endTime) {
        const timerElement = document.getElementById('timer');
        const interval = setInterval(() => {
            const now = new Date().getTime();
            const distance = endTime - now;

            if (distance <= 0) {
                clearInterval(interval);
                timerElement.textContent = 'Аукцион завершён';
                document.getElementById('bidForm').style.display = 'none';
            } else {
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                timerElement.textContent = `Осталось: ${days}д ${hours}ч ${minutes}м ${seconds}с`;
            }
        }, 1000);
    }
</script>
</body>
</html>