<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Аукцион.ру — Главная</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
    <div class="container">
        <a class="navbar-brand" href="index.html"><i class="fas fa-gavel"></i> Аукцион.ру</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="my-bids.html">Мои ставки</a></li>
                <li class="nav-item"><a class="nav-link" id="profileLink" href="profile.html" style="display: none;"><i class="fas fa-user"></i> Профиль</a></li>
                <li class="nav-item"><a class="nav-link" id="loginLink" href="login.html">Вход</a></li>
                <li class="nav-item"><a class="nav-link" id="registerLink" href="register.html">Регистрация</a></li>
                <li class="nav-item"><button id="logoutButton" class="btn btn-danger btn-sm" style="display: none;">Выйти</button></li>
            </ul>
        </div>
    </div>
</nav>

<header class="hero text-center text-white" style="background: #343a40; padding: 50px 0;">
    <div class="container">
        <h1 class="display-4">Лучшие товары на аукционе</h1>
        <p class="lead">Ставьте и выигрывайте уникальные лоты</p>
    </div>
</header>

<div class="container mt-5">
    <div class="d-flex align-items-center justify-content-between mb-4">
        <h2>Актуальные лоты</h2>
        <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="categoryDropdown" data-bs-toggle="dropdown">
                Все категории
            </button>
            <ul class="dropdown-menu" id="categoryList"></ul>
        </div>
    </div>
    <div id="lot-grid" class="row row-cols-1 row-cols-md-3 g-4"></div>
    <div id="loading" class="text-center my-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Загрузка...</span>
        </div>
    </div>
</div>

<footer class="bg-dark text-light text-center py-3 mt-5">
    <p>© 2025 Аукцион.ру. Все права защищены.</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentPage = 0;
    let isLoading = false;
    let selectedCategoryName = 'all';
    let hasMore = true;

    document.addEventListener('DOMContentLoaded', async () => {
        await loadCategories();
        loadAuctionLots();
        updateNavigation();
        window.addEventListener('scroll', handleScroll);
        document.getElementById('categoryList').addEventListener('click', handleCategorySelect);
    });

    async function loadCategories() {
        const userId = localStorage.getItem('userId');
        try {
            const response = await fetch('http://localhost:8080/categories', {
                headers: userId ? { 'X-User-Id': userId } : {}
            });
            const categories = await response.json();
            const categoryList = document.getElementById('categoryList');
            categoryList.innerHTML = '<li><a class="dropdown-item" href="#" data-category-name="all">Все категории</a></li>';
            categories.forEach(category => {
                const li = document.createElement('li');
                li.innerHTML = `<a class="dropdown-item" href="#" data-category-name="${category.name}">${category.name}</a>`;
                categoryList.appendChild(li);
            });
        } catch (error) {
            console.error('Ошибка:', error);
        }
    }

    async function loadAuctionLots() {
        if (isLoading || !hasMore) return;
        isLoading = true;
        document.getElementById('loading').style.display = 'block';

        const userId = localStorage.getItem('userId');
        try {
            const url = new URL('http://localhost:8080/feed');
            url.searchParams.append('page', currentPage);
            url.searchParams.append('size', 9);
            if (selectedCategoryName !== 'all') url.searchParams.append('categoryName', selectedCategoryName);

            const response = await fetch(url, {
                headers: userId ? { 'X-User-Id': userId } : {}
            });
            const lots = await response.json();

            if (lots.length < 9) hasMore = false;
            if (lots.length === 0 && currentPage === 0) {
                document.getElementById('lot-grid').innerHTML = '<p class="text-center">Нет доступных лотов</p>';
                return;
            }

            displayAuctionLots(lots);
            currentPage++;
        } catch (error) {
            console.error('Ошибка:', error);
        } finally {
            isLoading = false;
            document.getElementById('loading').style.display = 'none';
        }
    }

    function displayAuctionLots(lots) {
        const lotGrid = document.getElementById('lot-grid');
        lots.forEach(lot => {
            const col = document.createElement('div');
            col.className = 'col';
            col.innerHTML = `
                <div class="card h-100 shadow-sm">
                    <img src="${lot.images?.[0]?.url || 'images/banner.jpg'}" class="card-img-top" alt="${lot.title}" style="height: 200px; object-fit: cover;">
                    <div class="card-body">
                        <h5 class="card-title">${lot.title}</h5>
                        <p class="card-text text-muted">${lot.description || ''}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge bg-primary">${lot.categoryName || 'Без категории'}</span>
                            <h5 class="text-success">${lot.currentPrice.toFixed(2)}₽</h5>
                        </div>
                        <a href="lot.html?id=${lot.id}" class="stretched-link"></a>
                    </div>
                    <div class="card-footer bg-transparent">
                        <small class="text-muted">Окончание: ${new Date(lot.endTime).toLocaleDateString()}</small>
                    </div>
                </div>
            `;
            lotGrid.appendChild(col);
        });
    }

    function handleCategorySelect(event) {
        event.preventDefault();
        const categoryItem = event.target.closest('[data-category-name]');
        if (!categoryItem) return;

        selectedCategoryName = categoryItem.dataset.categoryName;
        currentPage = 0;
        hasMore = true;
        document.getElementById('lot-grid').innerHTML = '';
        document.getElementById('categoryDropdown').textContent = categoryItem.textContent;
        loadAuctionLots();
    }

    function handleScroll() {
        const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
        if (scrollTop + clientHeight >= scrollHeight - 100) loadAuctionLots();
    }

    function updateNavigation() {
        const userId = localStorage.getItem('userId');
        const profileLink = document.getElementById('profileLink');
        const logoutButton = document.getElementById('logoutButton');
        const loginLink = document.getElementById('loginLink');
        const registerLink = document.getElementById('registerLink');

        if (userId) {
            profileLink.style.display = 'block';
            logoutButton.style.display = 'block';
            loginLink.style.display = 'none';
            registerLink.style.display = 'none';
            logoutButton.onclick = () => {
                localStorage.removeItem('userId');
                window.location.reload();
            };
        } else {
            profileLink.style.display = 'none';
            logoutButton.style.display = 'none';
            loginLink.style.display = 'block';
            registerLink.style.display = 'block';
        }
    }
</script>
</body>
</html>